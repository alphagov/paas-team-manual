<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>ADR007 - Terminating TLS at ELBs - PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR007-terminating-tls-at-elbs/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="ADR007 - Terminating TLS at ELBs - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR007-terminating-tls-at-elbs/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="ADR007 - Terminating TLS at ELBs" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR007-terminating-tls-at-elbs/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="govuk-button search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#adr007-terminating-tls-at-elbs"><span>ADR007: Terminating TLS at ELBs</span></a>
    <ul>
      <li>
        <a href="#context"><span>Context</span></a>
      </li>
      <li>
        <a href="#decision"><span>Decision</span></a>
      </li>
      <li>
        <a href="#status"><span>Status</span></a>
      </li>
      <li>
        <a href="#consequences"><span>Consequences</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="adr007-terminating-tls-at-elbs">ADR007: Terminating TLS at ELBs</h1><h2 id="context">Context</h2><p>We needed to decide where to terminate TLS connections for public and tenant
facing endpoints and how to manage the corresponding private keys.</p>
<p>We had previously decided to only support HTTPS to both deployed applications
and Cloud Foundry endpoints.</p>
<p>At the time of writing there were 4 endpoints to consider:</p>

<ul>
<li>Deployed applications (gorouter). Accessed by the public.</li>
<li>CF API. Accessed by tenants.</li>
<li>UAA. Accessed by tenants.</li>
<li>Loggregator. Accessed by tenants.</li>
<li>SSH proxy. In theory accessed by tenants, but not working in our environment.</li>
</ul>
<p>We had an existing credentials store suitable for storing the private keys at
rest. Only a small number of engineers within the team can access; the same
ones that can make IAM changes using our account-wide terraform config.</p>
<p>Placing ELBs in front of public-facing services is an architectural pattern
advised by Amazon <a href="https://d0.awsstatic.com/whitepapers/DDoS_White_Paper_June2015.pdf">in order to reduce attack
surface</a>.
Specifically they advise that it helps withstand volumetric Denial of Service
attacks; the ELB handles TCP connections and therefore the responsibility for
handling DDOS at Layer 4 and below resides with the ELB team.</p>
<p>We did a spike, where we attempted to place everything public-facing or
tenant-facing behind ELBs. We found that:</p>

<ul>
<li>In HTTP mode the ELBs do not support web sockets. This is known to break
loggregator, which relies on them for log streaming. It would also prevent
tenants from using web sockets within their applications.</li>
<li>When the ELB is in TCP mode, we have no way of communicating the client IP
address to the downstream service. Practical consequences of this would be
that tenants would be unable to see in their logs who is using their service or
do any access control based on client IP address.</li>
</ul>
<p>In attempting to solve the second problem, we explored some options:</p>

<ul>
<li>ELB has support for the <a href="http://www.haproxy.org/download/1.5/doc/proxy-protocol.txt">Proxy
Protocol</a>, but
unfortunately none of the downstream services, such as gorouter, support it. It
seemed simple to add support to gorouter.</li>
<li>We could introduce another intermediary proxy such as HAProxy, which
understands the proxy protocol and adds or appends to an <code>X-Forwarded-For</code>
header with the client IP address as provided via the proxy protocol.</li>
</ul>
<h2 id="decision">Decision</h2><p>We decided to:</p>

<ul>
<li>use the ELB to terminate TLS</li>
<li>use the ELB in TCP mode</li>
<li>submit proxy protocol support to gorouter</li>
<li>use S3 logging to ensure we have the IP addresses of clients using the CF
endpoint</li>
</ul>
<h2 id="status">Status</h2><p>Accepted</p>
<h2 id="consequences">Consequences</h2>
<ul>
<li>We played a <a href="https://www.pivotaltracker.com/projects/1275640/stories/116619465">spike to investigate setting X-Forwarded-For
correctly</a>
which produced an <a href="https://github.com/cloudfoundry/gorouter/pull/126">upstream PR to add proxy protocol support to
gorouter</a> and <a href="https://github.com/cloudfoundry/gorouter/pull/127">another to introduce
X-Forwarded-Proto headers</a></li>
<li>As an interim measure until gorouter gained support, <a href="https://www.pivotaltracker.com/story/show/116309951">we added an
intermediate HAProxy to introduce <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code>
headers</a>.</li>
</ul>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
