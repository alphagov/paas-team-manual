<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>ADR003 - AWS credentials - PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR003-AWS-credentials/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="ADR003 - AWS credentials - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR003-AWS-credentials/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="ADR003 - AWS credentials" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR003-AWS-credentials/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="govuk-button search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#adr003-aws-credentials"><span>ADR003: AWS credentials</span></a>
    <ul>
      <li>
        <a href="#context"><span>Context</span></a>
      </li>
      <li>
        <a href="#decision"><span>Decision</span></a>
      </li>
      <li>
        <a href="#status"><span>Status</span></a>
      </li>
      <li>
        <a href="#consequences"><span>Consequences</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="adr003-aws-credentials">ADR003: AWS credentials</h1><h2 id="context">Context</h2><p>Amazon Web Services (AWS) are our current Infrastructure as a Service (IaaS)
provider. Our deployment tooling (Concourse, Terraform, BOSH, etc.) and
Cloud Foundry components (Cloud Controller, RDS broker, blobstore clients,
etc.) use the APIs to manage or access IaaS resources.</p>
<p>The most common mechanism for authenticating the API calls is to create an
Identify and Access Management (IAM) user with the appropriate permissions,
generate an Access Key ID and Secret Access Key for that user, and export
those as environment variables. <code>AWS_ACCESS_KEY_ID</code> and
<code>AWS_SECRET_ACCESS_KEY</code> are the standard environment variable names used by
most utilities and libraries.</p>
<p>The problem with this approach is that it&rsquo;s very easy to accidentally leak
the plain text keys. They can appear in output from your shell, which you
might copy+paste into a gist or email when debugging a problem. You might
add them to your shell configuration or include them in a script, which can
be pushed to a public code repository.</p>
<p>Our team have leaked keys like this on more than one occasion. It&rsquo;s worth
noting that even if you realise that you&rsquo;ve done this, delete the commit and
revoke the keys, they may have already been used maliciously because
automated bots monitor sites like GitHub using the <a href="https://developer.github.com/v3/activity/events/">events firehose</a> to
detect any credentials.</p>
<p>As an alternative to using pre-generated keys, AWS recommends that you use
<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#use-roles-with-ec2">IAM roles and instance profiles</a> when accessing the API from EC2
instances. You delegate permissions to the EC2 instance and temporary
credentials are made available from the instance metadata service. Most
tools and libraries automatically support this. The credentials are
regularly rotated and never need to be stored in configuration files.</p>
<h2 id="decision">Decision</h2><p>To reduce the likelihood of us leaking AWS keys we will use IAM roles and
instance profiles for all operations that run from EC2 instances. This
includes everything that happens within Concourse and Cloud Foundry.</p>
<p>To reduce the impact of us leaking AWS keys we will use an IAM policy with
an <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_examples.html#iam-policy-example-deny-source-ip-address"><code>aws:SourceIp</code> condition</a> to
enforce that IAM accounts for team members are only used from the office IP
addresses.</p>
<p>The IAM roles, profiles, and policies will be managed by our
<a href="https://github.digital.cabinet-office.gov.uk/government-paas/aws-account-wide-terraform">aws-account-wide-terraform</a> repo.</p>
<h2 id="status">Status</h2><p>Accepted</p>
<h2 id="consequences">Consequences</h2><p>We&rsquo;ll still need to use AWS keys for operations that run outside of EC2.
Care must be taken when storing and handling these credentials. These
operations include:</p>

<ul>
<li>Creation of Bootstrap Concourse instance</li>
<li>Running of <code>aws-account-wide-terraform</code></li>
</ul>
<p>Using IAM profiles has the drawback that any process running on the VM can
get the same credentials. This model does not play well when it is required
to assign the credentials to specific processes running in different containers
(for example concourse, CF apps), as all the containers will have access to
the AWS IAM profile.</p>
<p>We&rsquo;ll need to maintain our own forks of some standard Concourse resources to
add support for IAM roles and instance profiles because the maintainers
don&rsquo;t wish to support this feature (<a href="https://github.com/concourse/s3-resource/pull/22">concourse/s3-resource/pull/22</a>).
These resources include:</p>

<ul>
<li><a href="https://github.com/alphagov/paas-s3-resource">alphagov/paas-s3-resource</a></li>
<li><a href="https://github.com/alphagov/paas-semver-resource">alphagov/paas-semver-resource</a></li>
</ul>
<p>We&rsquo;ll need to use the office VPN to administer AWS when outside of the
office. This matches what we have to do to administer Concourse or Cloud
Foundry from outside the office. There are disaster recovery provisions for
the VPN if the office has connectivity problems.</p>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
