<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">

    <title>PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR014-hsts-preload-using-api-gateway/">


      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR014-hsts-preload-using-api-gateway/" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta property="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="PaaS Team Manual" />
      <meta property="twitter:url" content="https://team-manual.cloud.service.gov.uk/architecture_decision_records/ADR014-hsts-preload-using-api-gateway/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header " role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              
              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#adr014-hsts-preload-using-api-gateway"><span>ADR014: HSTS preload using api gateway</span></a>
    <ul>
      <li>
        <a href="#context"><span>Context</span></a>
      </li>
      <li>
        <a href="#decision"><span>Decision</span></a>
      </li>
      <li>
        <a href="#status"><span>Status</span></a>
      </li>
      <li>
        <a href="#consequences"><span>Consequences</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="adr014-hsts-preload-using-api-gateway">ADR014: HSTS preload using api gateway</h1><h2 id="context">Context</h2><p>We will only <a href="../ADR443-ssl-only-for-applications-and-cf-endpoints">serve HTTPS traffic, keeping TCP port 80 (HTTP) closed and use HSTS preload lists</a>.</p>
<p>To add our domains to <a href="https://hstspreload.appspot.com/">HSTS preload lists</a>, there are these requirements:</p>

<ol>
<li>Serve a valid certificate.</li>
<li>Redirect from HTTP to HTTPS on the same host.</li>
<li>Serve all subdomains over HTTPS (actually checks for <code>www.domain.com</code>)</li>
<li>Serve an HSTS header on the base domain for HTTPS requests:</li>
</ol>
<p>We need an endpoint to provide these requirements.</p>
<p>Our Cloud Foundry app endpoint already <a href="../ADR008-haproxy-for-request-rewriting">serves the
right HSTS Security header with HAProxy</a>
and could be configured to serve the additional <code>preload</code> and <code>includeSubDomains</code> flags,
but we cannot use it because we keep port 80 (HTTP) closed for this endpoint.
We can implement a second ELB to listening on HTTP and HTTPS and use
HAProxy to do the HTTP to HTTPS redirect and serve the right header.
But this increases our dependency on the HAProxy service.</p>
<p>We must serve from the root domain (or apex domain), but it is not allowed to
serve <a href="http://serverfault.com/questions/613829/why-cant-a-cname-record-be-used-at-the-apex-aka-root-of-a-domain">CNAME records in the root/apex domain</a>. We must configure A records in this domain. This can be
an issue when serving the service using ELB or CloudFront.</p>
<h2 id="decision">Decision</h2>
<ul>
<li><p>We will implement a basic <a href="https://aws.amazon.com/api-gateway/">AWS API Gateway</a>
with a default <a href="https://aws.amazon.com/about-aws/whats-new/2015/09/introducing-mock-integration-generate-api-responses-from-api-gateway-directly/">MOCK response</a>
that returns the right HTTP header <code>Strict-Transport-Security</code>. The actual
content of the response is irrelevant, it can be a 302.
A <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-custom-domains.html">Custom Domain Name</a>,
which creates a <a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-overview.html">AWS Cloud Front distribution</a>,
will provide public access to this API.</p></li>
<li><p>We will use <a href="http://docs.aws.amazon.com/Route53/latest/APIReference/CreateAliasRRSAPI.html">AWS Route 53 <code>ALIAS</code> resource record</a>
to <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-cloudfront-distribution.html">serve the IPs of the AWS Cloud Front distribution as A records</a>.</p></li>
</ul>
<h2 id="status">Status</h2><p>Accepted</p>
<h2 id="consequences">Consequences</h2><p>To setup AWS API Gateway Domain Names, it is required access to the SSL certificates. There is the option of uploading the certificates in a different step and create the AWS Cloud Front distribution manually.</p>


            
          </main>


          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        role="presentation"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
