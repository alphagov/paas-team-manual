<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Rotating Credentials - PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/team/rotating_credentials/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Rotating Credentials - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/team/rotating_credentials/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="Rotating Credentials" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/team/rotating_credentials/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#rotating-credentials"><span>Rotating Credentials</span></a>
    <ul>
      <li>
        <a href="#third-party-services"><span>Third-party services</span></a>
      </li>
      <li>
        <a href="#platform"><span>Platform</span></a>
        <ul>
          <li>
            <a href="#rotating-platform-credentials"><span>Rotating platform credentials</span></a>
            <ul>
              <li>
                <a href="#rotating-bosh-and-concourse-credentials"><span>Rotating BOSH and Concourse credentials</span></a>
              </li>
              <li>
                <a href="#rotating-cloud-foundry-and-prometheus-credentials"><span>Rotating Cloud Foundry and Prometheus credentials</span></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#rotating-broker-credentials"><span>Rotating broker credentials</span></a>
          </li>
          <li>
            <a href="#rotating-ca-and-leaf-certificates"><span>Rotating CA and leaf certificates</span></a>
          </li>
          <li>
            <a href="#rotating-sso-idp-keys"><span>Rotating SSO IDP keys</span></a>
          </li>
          <li>
            <a href="#aws-keys-generated-in-the-pipeline"><span>AWS keys generated in the pipeline</span></a>
          </li>
          <li>
            <a href="#limited-functionality-during-rotation"><span>Limited functionality during rotation</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="rotating-credentials">Rotating Credentials</h1>
<h2 id="third-party-services">Third-party services</h2>
<p>We store credentials for third-party services in <a href="https://www.passwordstore.org/"><code>pass</code></a> stores which have some documentation about rotating the secrets held in them:</p>

<ul>
<li>https://github.com/alphagov/paas-credentials/blob/master/SECRET_ROTATION.md</li>
<li>https://github.com/alphagov/paas-credentials-high/blob/master/SECRET_ROTATION.md</li>
</ul>
<h2 id="platform">Platform</h2>
<p>From time to time, it might be necessary to rotate our platform credentials. We
have created helper tasks in the deployer and bootstrap pipelines to regenerate
passwords that we know are safe to be rotated. This can be found under the
<code>credentials</code> tab of each Concourse pipeline.</p>
<h3 id="rotating-platform-credentials">Rotating platform credentials</h3>
<p>We have Concourse jobs for rotating credentials that can be rotated without
downtime. These might not include everything. If you are responding to a
security incident then it is worth checking whether the credentials you
care about are included.</p>
<p>Credential rotation is done in two phases:</p>

<ol>
<li>rotation in the secret store (Credhub)</li>
<li>deployment of the secrets</li>
</ol>
<p>These jobs are not run very often. It is wise to re-examine them for drift. Perform a test run in a development environment before executing them in a production environment.</p>
<p>If something goes wrong then in many cases
you can obtain the old passwords from the credential history in Credhub using
the <code>--versions</code> flag of <code>credhub get</code>:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>$ credhub get -n /prod-lon/prod-lon/cf_admin_password --versions=10

- id: 764582ca-b3f0-4d08-8da4-6a48b69907fd
  name: /prod-lon/prod-lon/cf_admin_password
  type: password
  value: [redacted newest password]
  version_created_at: "2020-03-13T11:22:50Z"
- id: 949f97e8-5ba3-4e64-8bf2-49dc3b94ec7a
  name: /prod-lon/prod-lon/cf_admin_password
  type: password
  value: [redacted previous password]
  version_created_at: "2020-03-11T10:10:13Z"
</code></pre></div><h4 id="rotating-bosh-and-concourse-credentials">Rotating BOSH and Concourse credentials</h4>
<p>In <code>create-bosh-concourse</code> there are two rotation jobs under the <code>credentials</code>
tab: <code>rotate-bosh-passwords</code> for BOSH and <code>clear-concourse-credentials</code> for Concourse</p>
<p>To perform the rotation:
1. Pause the <code>create-bosh-concourse</code> pipeline, and ensure it isn&rsquo;t running
1. Run the relevant rotation Concourse job (<code>rotate-bosh-passwords</code> and/or <code>clear-concourse-credentials</code>)
1. Unpause the <code>create-bosh-concourse</code> pipeline
1. Trigger the <code>create-bosh-concourse</code> pipeline and allow it to run all the way through</p>
<h4 id="rotating-cloud-foundry-and-prometheus-credentials">Rotating Cloud Foundry and Prometheus credentials</h4>
<p>In <code>create-cloudfoundry</code> there are four rotation jobs under the <code>credentials</code>
tab:</p>

<ul>
<li><code>rotate-cloudfoundry-credentials</code></li>
<li><code>rotate-cf-admin-password</code></li>
<li><code>rotate-prometheus-credentials</code></li>
<li><code>rotate-database-encryption-keys</code></li>
</ul>
<p>To perform the rotation:
1. Pause the <code>create-cloudfoundry</code> pipeline and ensure it isn&rsquo;t running
1. Run one or more of the above rotation jobs as necessary
1. Unpause the <code>create-cloudfoundry</code> pipeline
1. Trugger the <code>create-cloudfoundry</code> pipeline and allow it to run to completion</p>
<h3 id="rotating-broker-credentials">Rotating broker credentials</h3>
<p>Our service brokers have basic auth in front of them to ensure that only we
can communicate with them. Unfortunately our brokers do not support swapping
credentials without downtime.</p>
<p>In the <code>create-cloudfoundry</code> pipeline, under the <code>credentials</code> tab, there
is a <code>rotate-broker-credentials</code> job. Rotating the broker credentials is a
two step process:</p>

<ol>
<li>Run the <code>rotate-broker-credentials</code> job to update the credentials in Credhub.</li>
<li>Run the main <code>create-cloudfoundry</code> job to apply the new credentials.</li>
</ol>
<p>There will be downtime between when the pipeline redeploys the brokers and
when it updates the broker credentials to be used by Cloud Controller. For
information on what happened the first time, and how to communicate this to
tenants, see https://status.cloud.service.gov.uk/incidents/3qll54zh55zk.</p>
<p>At the time of writing this only rotates the basic auth used to talk to the
brokers. It does not rotate other difficult secrets, such as those used to
generate passwords for service instances.</p>
<h3 id="rotating-ca-and-leaf-certificates">Rotating CA and leaf certificates</h3>
<p>We rotate CA and leaf certificates automatically as part of the <code>create-cloudfoundry</code>
Concourse pipeline. You can learn more about it by reading <a href="/architecture_decision_records/ADR037-automated-certificate-rotation/">ADR037 automated certificate rotation</a></p>
<h3 id="rotating-sso-idp-keys">Rotating SSO IDP keys</h3>
<p>We use single sign-on using Google and Microsoft to allow our tenants to sign
in, without using a username and password stored in UAA.</p>
<p>Google has two credentials: <code>client_id</code> and <code>client_secret</code></p>
<p>Microsoft functionally has three credentials <code>client_id</code>, <code>client_secret</code>, and
<code>tenant_id</code>, however <code>tenant_id</code> is not secret, we just store it as such.</p>
<p>UAA is not capable of consuming multiple pairs of <code>client_id</code> and <code>client_secret</code>.
Rotating these credentials will briefly prevent users from signing in to GOV.UK
PaaS using single sign-on via the IDP with credentials currently being rotated.</p>
<p>Rotating these credentials requires changing the values in <code>paas-credentials</code>
and running the <code>upload-{google,microsoft}-oauth-secrets</code> Make tasks and then
running <code>create-cloudfoundry</code>.</p>
<h3 id="aws-keys-generated-in-the-pipeline">AWS keys generated in the pipeline</h3>
<p>The deployer Concourse has a job for triggering the rotation of AWS keys generated in the pipeline. These keys currently include:</p>

<ul>
<li>Those used for generating SES SMTP credentials used by UAA for sending account management emails.</li>
<li>Those used by the metrics tool to check the validity of CloudFront certificates.</li>
</ul>
<p>The job works by removing the resources from the Terraform state file (without touching the keys themselves). This causes new access keys to be generated on the next pipeline run. Unused keys are deleted in a post-deploy job after every pipeline run. This operation is safe to do at any time, so it triggers automatically every 30 days. It is also included as a step in the manual credential rotation job.</p>
<h3 id="limited-functionality-during-rotation">Limited functionality during rotation</h3>
<p>We have lot of functionality that requires credentials outside of the pipeline. These are mainly our scripts that are orchestrated via Makefile. Most of the tasks (like <code>bosh-cli</code> or any ssh tasks) will not work during rotation, as they need credentials (concourse password, ssh keys) that have been deleted and are either not available or not applied yet.</p>
<p>In case you need to run any of these tasks in the middle of the rotation, but before the new credentials have been applied, we suggest that you pause the pipeline first. You can download previous versions of the keys and secret files to recover needed credentials and either use them locally, or re-upload these files as latest version to the bucket. Note that if your pipeline will get into credential applying stage after you unpause, it will apply the latest uploaded credentials. If these are previous version, this means no actual credential rotation will happen and pipeline should finish without needing to apply any changes. If you still want to rotate credentials afterwards, repeat the rotation procedure again.</p>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
