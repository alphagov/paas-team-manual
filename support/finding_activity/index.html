<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/support/finding_activity/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/support/finding_activity/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/support/finding_activity/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              
              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#finding-the-activity-for-a-given-user"><span>Finding the activity for a given user</span></a>
    <ul>
      <li>
        <a href="#finding-user-guid"><span>Finding user GUID</span></a>
        <ul>
          <li>
            <a href="#finding-deleted-user-guid"><span>Finding deleted user GUID</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#kibana-finding-api-usage"><span>Kibana: Finding API usage</span></a>
      </li>
      <li>
        <a href="#getting-further"><span>Getting further</span></a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#finding-the-access-logs"><span>Finding the access logs</span></a>
    <ul>
      <li>
        <a href="#gorouter"><span>Gorouter</span></a>
      </li>
      <li>
        <a href="#router-haproxy"><span>Router HAProxy</span></a>
      </li>
      <li>
        <a href="#cloud-controller"><span>Cloud Controller</span></a>
        <ul>
          <li>
            <a href="#uaa-audit-log-in-detail"><span>UAA audit log in detail</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#finding-paas-internal-application-logs"><span>Finding PaaS internal application logs</span></a>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="finding-the-activity-for-a-given-user">Finding the activity for a given user</h1><p>In case of suspicion of compromised CF details, we can use Kibana to
obtain some information about the API use.</p>
<h2 id="finding-user-guid">Finding user GUID</h2><p>To find the user ID of a particular user see <a href="/support/CF_UAA_user_management/#finding-a-user-account">finding a user account</a></p>
<h3 id="finding-deleted-user-guid">Finding deleted user GUID</h3><p>There may be a need to find a GUID for already deleted user. There is a
way to do that, but it&rsquo;s a little inconvenient&hellip;</p>
<p>If you go to Kibana, you can use the <code>&quot;DELETE \&quot;/v2/users&quot;</code> phrase in
your search. This will print out the logs that were taken on user
removal. This does not however, give you an indication of who the user
was.</p>
<h2 id="kibana-finding-api-usage">Kibana: Finding API usage</h2><p>We can make the investigation easier for ourselves by considering the
following criteria:</p>

<ul>
<li>Filter by user by typing <code>&quot;for user: {GUID}&quot;</code> in a search box</li>
<li><em>Optionally:</em> Scope to job: <code>api</code> - From the sidebar on the left,
select <code>@source.job</code> and add <code>api</code> by pressing little magnifying glass
with a plus sign.</li>
<li><code>@message</code> should consist of:

<ul>
<li>Detailed endpoint - You may filter by adding <code>&quot;/v2/apps/{APP_GUID}&quot;</code>, <code>&quot;GET \&quot;/v2/jobs&quot;</code></li>
<li>IP address - You may filter by adding <code>&quot;ip: {IP_ADDRESS}&quot;</code></li>
<li>vcap_request_id - You may filter by adding <code>&quot;vcap-request-id:
{REQUEST_GUID}&quot;</code></li>
</ul></li>
</ul>
<p>You can combine many quoted attributes into one, by joining the quotes
with <code>&amp;&amp;</code>, like so:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>"for user: {GUID}" &amp;&amp; "ip: {IP_ADDRESS}" &amp;&amp; "GET \"/v2/jobs"
</code></pre></div><p>It probably won&rsquo;t end here, but it should provide a start for an
individual to go further.</p>
<h2 id="getting-further">Getting further</h2><p>Once you found something interesting above, you could use it to refine
your search to get deeper. For instance, one of the logs above, would have:</p>

<ul>
<li><code>@source.id</code> - Defining the VM we&rsquo;d need to access. For example:
<code>4556706c-0e04-401e-bbc5-d0933e98f892</code></li>
<li><code>@message</code> consisting of <code>vcap-request-id</code></li>
</ul>
<p>If you search for <code>&quot;{VCAP_REQUEST_ID}&quot;</code> in Kibana, you should get
more actions performed on an API call.</p>
<p>Each of the results will be different, but it could consist of more
data. For example, with a <code>PUT</code> request, you could find a
<code>cloud_controller_ng.body</code>, <code>cloud_controller_ng.method</code> and
<code>cloud_controller_ng.message</code>.</p>
<p>Here&rsquo;s a sample JSON of the above:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>{
    "timestamp": 1492615195.9275572,
    "message": "droplet created: XXXXX-XXXX-XXXX-XXXXX",
    "log_level": "info",
    "source": "cc.package_stage_action",
    "data": {
        "request_guid": "XXXXX-XXXX-XXXX-XXXXX"
    },
    "thread_id": XXXXXXXXXX,
    "fiber_id": XXXXXXXXXX,
    "process_id": XXXX,
    "file": "/var/vcap/packages/cloud_controller_ng/cloud_controller_ng/app/actions/droplet_create.rb",
    "lineno": 52,
    "method": "create_and_stage"
}
</code></pre></div><p>It would imply that a new app has been created and staged.</p>
<h1 id="finding-the-access-logs">Finding the access logs</h1><p>There may be times, where we&rsquo;d need to be troubleshooting or reviewing an API Access logs. Here is a list, of more relevant and interesting points to be concerned about:</p>
<h2 id="gorouter">Gorouter</h2><p>In kibana, filtering the <code>@source.component</code> to <code>gorouter</code> will show the access logs, error logs, and route registration events.</p>
<p>You can filter access logs only with:</p>

<ul>
<li><code>tags:gorouter_access_log</code></li>
</ul>
<p>Request details are also parsed to allow searches like:</p>

<ul>
<li><code>NOT gorouter.status: 200</code></li>
<li><code>gorouter.method: POST</code></li>
</ul>
<h2 id="router-haproxy">Router HAProxy</h2><p>In Kibana, you can look for the following phrases, to filter the access logs.</p>

<ul>
<li><code>haproxy.http_status_code: 200</code></li>
<li><code>NOT haproxy.http_status_code: 200</code></li>
<li><code>haproxy.http_request_verb: POST</code></li>
<li><code>haproxy.time_backend_response: &gt;7</code></li>
</ul>
<h2 id="cloud-controller">Cloud Controller</h2><p>Nginx runs on the same VM as Cloud Controller, so you can filter with:</p>

<ul>
<li><code>@source.component:vcap_nginx_access</code></li>
</ul>
<h3 id="uaa-audit-log-in-detail">UAA audit log in detail</h3><p>You may find it necessary, to go deeper into the audit logs:</p>

<ul>
<li>Token issued for a user: <code>uaa.audit.origin: &quot;test@example.com&quot;</code></li>
<li>All user created events: <code>uaa.audit.type: UserCreatedEvent</code></li>
<li>All token issued events: <code>uaa.audit.type: TokenIssuedEvent</code></li>
<li>All token issued events (case doesn&rsquo;t matter):<code>uaa.audit.type: tokenissuedevent</code></li>
<li>All successful authentication events: <code>uaa.audit.type: UserAuthenticationSuccess</code></li>
<li>Authentication of a user: <code>uaa.audit.data: &quot;test@example.com&quot;</code></li>
<li>All successful authentication events via SSO: <code>uaa.audit.type: UserAuthenticationSuccess AND uaa.audit.origin: sessionId</code></li>
<li>All successful authentication events via non SSO: <code>uaa.audit.type: UserAuthenticationSuccess AND uaa.audit.origin: clientId</code></li>
<li>Authentication failures: <code>uaa.audit.type: PrincipalAuthenticationFailure</code></li>
<li>Authentication failure for a user: <code>uaa.audit.type: PrincipalAuthenticationFailure AND uaa.audit.principal: admin</code></li>
<li>SSO authentication failure doesn&rsquo;t show specific logs, only <code>uaa.audit.type: ClientAuthenticationSuccess</code> from the cf client.</li>
</ul>
<h1 id="finding-paas-internal-application-logs">Finding PaaS internal application logs</h1><p>For certain applications we forward the logs to Logit using a syslog drain. In Kibana you can use the following filters to search for such logs:</p>
<p>To list all application logs:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>tags: logmessage
</code></pre></div><p>To list all application routing logs:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>tags: "logmessage-rtr"
</code></pre></div><p>To list all logs written by the application:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>tags: "logmessage-app"
</code></pre></div><p>To filter by application name:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>@source.host:"&lt;org&gt;.&lt;space&gt;.&lt;app name&gt;", e.g. @source.host:"admin.public.paas-admin"
</code></pre></div><p>To filter by guid:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>@source.component:"&lt;GUID&gt;", e.g. @source.component:"6e70d438-d9ac-4576-816f-9d5511eb3e43"
</code></pre></div>

            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
