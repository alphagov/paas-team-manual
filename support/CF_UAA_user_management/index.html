<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/support/CF_UAA_user_management/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/support/CF_UAA_user_management/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/support/CF_UAA_user_management/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              
              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#user-management"><span>User management</span></a>
    <ul>
      <li>
        <a href="#creating-new-orgs-and-users"><span>Creating new orgs and users</span></a>
      </li>
      <li>
        <a href="#interacting-with-uaa"><span>Interacting with UAA</span></a>
        <ul>
          <li>
            <a href="#install"><span>Install</span></a>
          </li>
          <li>
            <a href="#log-in"><span>Log in</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#finding-a-user-account"><span>Finding a user account</span></a>
      </li>
      <li>
        <a href="#locking-a-user-account"><span>Locking a user account</span></a>
      </li>
      <li>
        <a href="#finding-out-org-membership"><span>Finding out org membership</span></a>
      </li>
      <li>
        <a href="#notifying-the-org-manager"><span>Notifying the org manager</span></a>
      </li>
      <li>
        <a href="#global-auditor-role"><span>Global Auditor role</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="user-management">User management</h1><h2 id="creating-new-orgs-and-users">Creating new orgs and users</h2><p>We encourage tenants to invite and manage their own users via the paas-admin interface.</p>
<p>If you need to create a new org and invite the initial org manager(s) you can do so using the <code>GOV.UK PaaS Admin &gt; Platform Admin &gt; Create new organisation</code> page. You should be creating new orgs in the London region by default.</p>
<h2 id="interacting-with-uaa">Interacting with UAA</h2><p>Cloud Foundry&rsquo;s account management is mostly controlled by <a href="https://github.com/cloudfoundry/uaa">UAA</a></p>
<h3 id="install">Install</h3><p>You can access the <a href="https://github.com/cloudfoundry/cf-uaac">uaac</a> command line utility from
<a href="https://github.com/alphagov/paas-cf">alphagov/paas-cf</a>. Using <a href="http://bundler.io/">Bundler</a> will ensure that you have the
appropriate version.</p>
<p>To install:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>➜  paas-cf git:(master) ✗ bundle install
…
</code></pre></div><p>To confirm that it works:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>➜  paas-cf git:(master) ✗ bundle exec uaac help

UAA Command Line Interface
…
</code></pre></div><h3 id="log-in">Log in</h3><p>To target an environment:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac target https://login.&lt;SYSTEM_DOMAIN&gt;
</code></pre></div><p>You can log in with a normal CF account. You should use either:</p>

<ul>
<li><p>for persistent environments where we have SSO admin users:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac token sso get cf -s ""
</code></pre></div></li>
<li><p>for development environments where we have a single CF admin account:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac token owner get cf admin -s ""
</code></pre></div></li>
</ul>
<p>Please avoid using <code>uaa_admin_client_secret</code> and <code>uaa_admin_password</code>
because it gives you more permissions than necessary and means that we can&rsquo;t
track activity in persistent environments.</p>
<p>There is a command to refresh your access token when it expires, but it is
worth re-authenticating instead to ensure that you are still targeting the
environment that you expect.</p>
<h2 id="finding-a-user-account">Finding a user account</h2><p>If you know the exact username of the account:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac user get &lt;EMAIL&gt;
</code></pre></div><p>If you only know part of the username:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac users 'username co "&lt;NAME&gt;"'
</code></pre></div><p>The above two commands will only work for users who are not using single-sign
on, PaaSmin has a page for getting diagnostic information about a user.
Navigate to one of the following, depending on the region:</p>

<ul>
<li><a href="https://admin.cloud.service.gov.uk/users/person@domain.com">https://admin.cloud.service.gov.uk/users/person@domain.com</a></li>
<li><a href="https://admin.london.cloud.service.gov.uk/users/person@domain.com">https://admin.london.cloud.service.gov.uk/users/person@domain.com</a></li>
</ul>
<p>The endpoint also works for UAA GUIDs:</p>

<ul>
<li><a href="https://admin.cloud.service.gov.uk/users/aaaaaaaa-bbbb-cccc-dddd-111122223333">https://admin.cloud.service.gov.uk/users/aaaaaaaa-bbbb-cccc-dddd-111122223333</a></li>
<li><a href="https://admin.london.cloud.service.gov.uk/users/aaaaaaaa-bbbb-cccc-dddd-111122223333">https://admin.london.cloud.service.gov.uk/users/aaaaaaaa-bbbb-cccc-dddd-111122223333</a></li>
</ul>
<h2 id="locking-a-user-account">Locking a user account</h2><p>Sometimes it might be necessary to lock certain user accounts. For example, when we find out they have left GDS or are no longer working on the PaaS team.</p>
<p>Cloud Foundry has a facility to prevent users from logging in while still preserving the user account with all their access rights and org membership. We use this facility as a first step in removing the user account and then:</p>

<ul>
<li>ask for confirmation from org managers (or managers of org managers if we are removing an org manager)</li>
<li>remove the account completely (<code>cf delete-user</code>) once we have received confirmation</li>
</ul>
<p>From <a href="https://github.com/alphagov/paas-cf">alphagov/paas-cf</a>:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle install
cd scripts
TARGET=$(cf curl /v2/info | jq -r .token_endpoint) \
  TOKEN=$(cf oauth-token) \
  bundle exec ./uaa_lock_user.rb &lt;USERNAME&gt;
</code></pre></div><h2 id="finding-out-org-membership">Finding out org membership</h2><p>In order to notify the org manager of a given user, we need to find out who that would be. UAA does not know which org/space user belongs to. This information is only available to cloud controller: <code>cf curl /v2/users/&lt;uaa_user_id&gt;/summary</code></p>
<p>The user summary contains all orgs and spaces they are member of. It also contains the UAA ID of managers of these. To get user name from UAA id, enter: <code>bundle exec uaac curl /Users/&lt;uaa_user_id&gt; | grep userName</code></p>
<h2 id="notifying-the-org-manager">Notifying the org manager</h2><p>Send an email from support email address: <code>gov-uk-paas-support@digital.cabinet-office.gov.uk</code>. Example email:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>Hi &lt;org manager 1st name&gt;,

We have noticed that &lt;user name of disabled account&gt; was inactive &lt;describe how we found out, e.g. when we tried to send him email and it got bounced&gt;. We wondered if perhaps this person has left GDS. We have noticed this user still has an account in `&lt;org name&gt;` organization and `&lt;space name(s)&gt;` space. We have disabled this user for now.

Can you please confirm if we can remove the user entirely, or instead if the user is still expected to have access to the PaaS?


Thanks,
PaaS for Government
</code></pre></div><p>When they respond support can follow up with user deletion, or instead enable the user account again if it is to be actively used.</p>
<h2 id="global-auditor-role">Global Auditor role</h2><p>We use the <a href="https://docs.cloudfoundry.org/concepts/roles.html#roles-and-permissions">Global Auditor role</a> for team members of our team that need to
query or report on usage but don&rsquo;t have production access.</p>
<p>To add someone:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac member add cloud_controller.global_auditor &lt;EMAIL&gt;
</code></pre></div><p>To remove someone:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bundle exec uaac member delete cloud_controller.global_auditor &lt;EMAIL&gt;
</code></pre></div><p>To see the current members:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>(set -o pipefail \
  &amp;&amp; bundle exec uaac group get cloud_controller.global_auditor \
  | awk '$1 == "value:" {print $2}' \
  | xargs -n1 -I{} bundle exec uaac users "id eq \"{}\"" -a username)
</code></pre></div>

            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
