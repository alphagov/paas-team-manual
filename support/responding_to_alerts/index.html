<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Responding to alerts - PaaS Team Manual</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/support/responding_to_alerts/">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Responding to alerts - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/support/responding_to_alerts/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="Responding to alerts" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/support/responding_to_alerts/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#responding-to-alerts"><span>Responding to alerts</span></a>
    <ul>
      <li>
        <a href="#failed-logins"><span>Failed logins</span></a>
      </li>
      <li>
        <a href="#cpu-credits"><span>CPU credits</span></a>
      </li>
      <li>
        <a href="#cdn-broker-healthy"><span>CDN broker healthy</span></a>
      </li>
      <li>
        <a href="#rds-failures"><span>RDS Failures</span></a>
      </li>
      <li>
        <a href="#rds-disk-utilisation"><span>RDS Disk utilisation</span></a>
        <ul>
          <li>
            <a href="#how-to-obtain-organisation-managers"><span>How to obtain organisation managers</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#ddos-mitigation"><span>DDoS mitigation</span></a>
      </li>
      <li>
        <a href="#api-latency"><span>API Latency</span></a>
      </li>
      <li>
        <a href="#intermittent-elb-failures"><span>Intermittent ELB failures</span></a>
      </li>
      <li>
        <a href="#invalid-certificates"><span>Invalid Certificates</span></a>
      </li>
      <li>
        <a href="#cloud-foundry-internal-certificates"><span>Cloud Foundry internal certificates</span></a>
      </li>
      <li>
        <a href="#trusted-advisor-warnings"><span>Trusted Advisor Warnings</span></a>
      </li>
      <li>
        <a href="#gorouter-high-latency-alerts"><span>Gorouter high latency alerts</span></a>
      </li>
      <li>
        <a href="#diego-cell-ephemeral-disk-usage-near-full"><span>Diego cell ephemeral disk usage near full</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="responding-to-alerts">Responding to alerts</h1>
<p>Tips for responding to alerts when you are on support.</p>
<h2 id="failed-logins">Failed logins</h2>
<p>In case of security incident, for example when alerted of a brute-force attack by Prometheus monitors,
it may help to look at UAA logs.</p>
<p>The access logs is on the UAA VMs in <code>/var/vcap/sys/log/uaa/localhost_access.log</code>.</p>
<p>All other logs are sent to <a href="https://logit.io/a/1c6b2316-16e2-4ca5-a3df-ff18631b0e74">logit</a>.
You must <a href="https://reliability-engineering.cloudapps.digital/manuals/logit-io-joiners.html">Log into logit via Google</a>[external link] before you can access kibana.</p>

<ul>
<li>Scope to component: UAA</li>
<li>filter by <code>@source.deployment: &quot;prod&quot;</code> or <code>@source.deployment: &quot;prod-lon&quot;</code> (depending on which deployment you are looking for)</li>
<li>Look for strings like <code>UserNotFound</code>, <code>PrincipalAuthenticationFailure</code> or <code>UserAuthenticationFailure</code></li>
<li><code>principal=XXX</code> will give you the username</li>
<li><code>origin=[1.2.3.4]</code> will give you the origin IP</li>
<li><code>UserAuthenticationSuccess</code> will give you the successful attempts

<ul>
<li>SSO authentication origin will show <code>sessionId=XXX</code></li>
<li>UAA authentication origin will show <code>clientId=cf</code></li>
</ul></li>
</ul>
<h2 id="cpu-credits">CPU credits</h2>
<p>These alerts tell us when an AWS instance that has burstable CPU performance
has exhausted its credits and is performing badly. This is an informational
alert that should help you understand why other alerts may be triggered at
the same time. For more information about CPU credits see:</p>

<ul>
<li><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/t2-instances.html#t2-instances-cpu-credits">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/t2-instances.html#t2-instances-cpu-credits</a></li>
</ul>
<h2 id="cdn-broker-healthy">CDN broker healthy</h2>
<p>The CDN broker has a healthcheck endpoint which confirms whether all of its
dependencies are working. If any are not working then the healthcheck
endpoint returns a 500 response code and response body containing the
errors.</p>
<p>Prometheus doesn&rsquo;t report the response body, which can make it hard to determine the actual problem. To
get this information you will need to SSH to any Cloud Foundry VM and query
the endpoint yourself:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>bash# bosh-ssh api/0
â€¦
api/00673a4a-b11f-410d-a037-34d56a3e2e71:~$ curl -i https://cdn-broker.&lt;SYSTEM_DOMAIN&gt;/healthcheck
HTTP/1.1 500 Internal Server Error
Content-Type: text/plain; charset=utf-8
Date: Fri, 02 Jun 2017 10:10:49 GMT
Content-Length: 52
Connection: keep-alive

cloudfoundry error: Could not get api /v2/info: EOF
</code></pre></div><h2 id="rds-failures">RDS Failures</h2>
<p>Unfortunately, many types of <code>failure</code> event are not resolvable without getting in touch with AWS. In some circumstances you may be
able to restore an instance using <a href="/guides/Restoring_the_CF_databases/">our point-in-time-restore
instructions</a>.</p>
<p>When <code>failure</code> monitor triggers, before starting any further investigation and
work, we would like to notify our users of odd behaviour and let them know
we&rsquo;re working to solve this issue. Please see the <a href="#how-to-obtain-organisation-managers">How to obtain organisation
managers</a> to learn who to contact.</p>
<p>For more information on the 8 types of <code>failure</code> event, see the <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Events.html#USER_Events.Messages">Amazon RDS
Event Categories and Event
Messages</a>.</p>
<h2 id="rds-disk-utilisation">RDS Disk utilisation</h2>
<p>Our tenants are likely to run low on storage on their RDS instances over time.
This is no reason to panic, but we would like to notify our users when this
happens.</p>
<p>Ideally, you should retrieve a GUID of an instance from the tags associated
with the metrics on the alert. Having that will help you establish the users to
contact, as they may wish to scale up their instance in response. Please see
the <a href="#how-to-obtain-organisation-managers">How to obtain organisation managers</a>
to learn who to contact.</p>
<h3 id="how-to-obtain-organisation-managers">How to obtain organisation managers</h3>
<p>We&rsquo;ve prepared a script to obtain organisation, space, instance name and the
list of managers connected to the instance you&rsquo;re after.</p>
<p>From <code>paas-cf</code> repository, run the following command:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>./scripts/get-instance-details.sh <span class="s2">"</span><span class="k">${</span><span class="nv">RDS_INSTANCE_ID</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div><h2 id="ddos-mitigation">DDoS mitigation</h2>
<p>When AWS detect a possible denial-of-service attack against PaaS, our in-hours
support gets an email. If you receive such an email, log into AWS Shield and look
at the details of what AWS have detected.</p>
<p>AWS automatically mitigate layer 3 and 4 attacks (i.e., junk network traffic.) You
should monitor PaaS&rsquo;s performance. Unless PaaS is degraded there is likely no need
to do more than monitor this.</p>
<p>AWS do not automatically mitigate layer 7 attacks (i.e., mass HTTP requests.) These
are not always malicious: large submissions to GOV.UK Notify can run at 900rps, and
AWS detects that as a request flood. Reviewing the details in AWS Shield can help
identify whether there is a real attack. You can create new AWS WAF rules to combat
this traffic.</p>
<p>If facing a large, complex or uncertain attack, contact the AWS DDoS Response Team
(DRT): https://docs.aws.amazon.com/waf/latest/developerguide/ddos-responding.html.</p>
<h2 id="api-latency">API Latency</h2>
<p>Last time we received an alert for API latency, it was a UAA bug that caused
instances to leak memory. It also resulted in high CPU usage and the quickest
solution to restoring the platform was to restart both instances one after the
other.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nb">cd</span> <span class="k">${</span><span class="nv">PAAS_BOOTSTRAP_DIR</span><span class="k">}</span>
<span class="nv">DEPLOY_ENV</span><span class="o">=</span>prod make prod bosh-cli
bosh restart uaa <span class="c"># You may want/need to target an instance, e.g. uaa/23888ebf-2dd3-4afe-b370-51705403d423</span>
</code></pre></div><p>There may be different reasons for the latency to drop down on any of the VMs.
We found out the issue by logging into the VM itself and dig through the logs.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nb">cd</span> <span class="k">${</span><span class="nv">PAAS_BOOTSTRAP_DIR</span><span class="k">}</span>
<span class="nv">DEPLOY_ENV</span><span class="o">=</span>prod make prod bosh-cli
bosh ssh uaa/23888ebf-2dd3-4afe-b370-51705403d423
<span class="nb">tail</span> <span class="nt">-1000</span> /var/vcap/sys/log/uaa/uaa.log
</code></pre></div><p>In the case of the UAA latency incident, it turned out that the CF Upgrade we
did previously, contained a UAA release introducing the memory leak. The
solution was to upgrade UAA release on its own.</p>
<p>Read more in the
<a href="https://www.pivotaltracker.com/n/projects/1275640/stories/151808174">UAA Downtime investigation</a>
story.</p>
<h2 id="intermittent-elb-failures">Intermittent ELB failures</h2>
<p>Users have previously experienced intermittent request timeouts and errors when
accessing their apps. During a particular incident, we believe that requests
timed out due to ELB node failures.</p>
<p>We publish two metrics:</p>

<ol>
<li><code>aws.elb.unhealthy_node_count</code> - number of IPs that failed to respond to an HTTP request</li>
<li><code>aws.elb.healthy_node_count</code>   - number of IPs that responded as expected</li>
</ol>
<p>Details of the monitoring approach can be found in
<a href="https://github.com/alphagov/paas-cf/blob/master/tools/metrics/README.md">the README for our monitoring application</a>.</p>
<p>We have been advised by AWS that if we believe we are experiencing an issue
with one or more ELB nodes that we should raise a &ldquo;high priority&rdquo; support
ticket with them.</p>
<p>To obtain the IP address of the failing node(s), you should inspect the logs of
the paas-metrics app. This is deployed to the &lsquo;monitoring&rsquo; space of the &lsquo;admin&rsquo;
org. You should see logs such as:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>2017-12-01T14:14:09.68+0000 [APP/PROC/WEB/0] OUT
{
    "timestamp":"1512137649.686135292",
    "source":"metrics",
    "message":"metrics.elb-node-failure",
    "log_level":1,
    "data":{
        "addr":"52.31.169.122:443",        &lt;-- this is the ELB node IP
        "err":"bad error happened!",
        "start":"2017-12-01T14:14:09.679602987Z",
        "stop":"2017-12-01T14:14:09.679602987Z"
    }
}
</code></pre></div><p>Read more in the
<a href="https://docs.google.com/document/d/1XUH42lgt86q2XGZY1uosb0M44vtnpeyREDJlyfxs72w/edit#heading=h.bac2cwm6xa89">Incident Report</a>.</p>
<h2 id="invalid-certificates">Invalid Certificates</h2>
<p><a href="https://github.com/alphagov/paas-cf/blob/master/tools/metrics/README.md">paas-metrics</a>
exposes two metrics relating to certificate validity:</p>

<ul>
<li><code>tls.certificates.validity</code> - number of days before expiry of the platform&rsquo;s public-facing certificates</li>
<li><code>cdn.tls.certificates.validity</code> - number of days before expiry of certificates for CloudFront aliases (tenants&rsquo; custom domain names). This is for all CDNs, not just those created by the broker.</li>
</ul>
<p>If the endpoints are misconfigured or the certificate is considered invalid for
some other reason the value will fall to <code>0</code> and alert as expired/invalid.</p>
<p>If the platform certificates are due to expire, check AWS Certificate Manager for the validation settings, as they should
validate automatically via DNS.</p>
<p>For CDN certificates start with AWS Certificate Manager in the <code>us-east-1</code> region to see why the certificate didn&rsquo;t get renewed. The most common cause is tenants removing the DNS records required for valdiation. Use <code>dig -t CNAME</code> to check if they&rsquo;re still set.</p>
<p>If you are seeing <code>NO_DATA</code> errors for this monitor then there may be a more
fundimental connectivity issue to the reported endpoint.</p>
<p>The <code>cf logs</code> output of the paas-metrics app may contain additional
information. This is deployed to the &lsquo;monitoring&rsquo; space of the &lsquo;admin&rsquo; org.</p>
<h2 id="cloud-foundry-internal-certificates">Cloud Foundry internal certificates</h2>
<p>We generate several certificates for Cloud Foundry which need to be rotated regularly (most of them have a 1 year expiry).</p>
<p>We have a <a href="https://deployer.cloud.service.gov.uk/teams/main/pipelines/create-cloudfoundry/jobs/check-certificates/builds/latest">Concourse job</a> which checks if we have certificates expiring in less than 30 days.</p>
<p>If you need to rotate a certificate before it would otherwise be rotated automatically, you can <a href="https://github.com/pivotal-cf/credhub-release/blob/master/docs/ca-rotation.md#step-1-regenerate">perform step 1</a> of the Credhub CA cert rotation, and then allow the pipeline to take over.</p>
<h2 id="trusted-advisor-warnings">Trusted Advisor Warnings</h2>
<p>If you see a warning from Trusted Advisor it should be addressed.</p>

<ul>
<li>IAM: Access keys should be rotated every 90 days, you should chase the owner
of the offending key, delete the key or you can use <a href="https://github.com/keymon/aws_key_management/blob/master/rotate_access_keys.sh">this script</a>
to help with rotating keys.</li>
</ul>
<p>The following Trusted Advisor checks cause expected warnings:</p>

<ul>
<li>S3 Bucket Permission&rsquo;s for <code>gds-paas-*-cdn-broker-challenge</code> are required to be publicly accesible so it is safe to mark these as excluded.</li>
<li>S3 Bucket Permission&rsquo;s for <code>gds-paas-*-ci-releases</code> are required to be publicly accesible so it is safe to mark these as excluded.</li>
<li>S3 Bucket Permission&rsquo;s for <code>gds-paas-*-ci-releases-blobs</code> are required to be publicly accesible so it is safe to mark these as excluded.</li>
<li>ELB Listener Security for <code>*-ssh-proxy</code>: This ELB is in TCP mode and so this warning is expected</li>
<li>Security Group - Specified Ports Unrestricted for <code>*-sshproxy</code>: We intentionally allow port 2222 for <code>cf ssh</code> access so it is safe to mark this as excluded.</li>
</ul>
<h2 id="gorouter-high-latency-alerts">Gorouter high latency alerts</h2>
<p>If you see an alert for gorouter latency being high;</p>

<ul>
<li>Check with the team if we have any known load testing occuring either by the team or by a tenant</li>
<li><a href="https://reliability-engineering.cloudapps.digital/manuals/logit-io-joiners.html">Log into logit via Google</a>[external link]</li>
<li>Visit <a href="https://kibana.logit.io/s/665ca355-efc3-46a2-96cf-21d31a5305bb/app/kibana#/">kibana</a> and filter by <code>@source.component: gorouter</code> and <code>@source.deployment: &quot;prod&quot;</code> or <code>@source.deployment: &quot;prod-lon&quot;</code> (depending on which deployment you are looking for) then add in <code>gorouter.host</code> to the table, this will show you which hosts are being most used currently</li>
<li>Contact the team who own the service to see if they are aware of anything happening</li>
</ul>
<p>As this is the first monitor of this type please investigate the gorouters to discover the issue they are encountering. We have previously seen high resource usage (CPU and Memory) these should be checked in the first case.</p>
<h2 id="diego-cell-ephemeral-disk-usage-near-full">Diego cell ephemeral disk usage near full</h2>
<p>To prevent a tenant-visible issue in the short term, it&rsquo;s probably a good idea to recreate the cell in bosh:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>cd ${PAAS_BOOTSTRAP_DIR}
DEPLOY_ENV=prod make prod bosh-cli
bosh restart diego-cell/123
</code></pre></div><p>In the long term, this should be investigated because it Shouldn&rsquo;t Happen. The grootfs
garbage collector should keep disk space under control, so perhaps this is a sign that
it isn&rsquo;t working properly.</p>
<p>The <a href="https://docs.google.com/document/d/1727mhApwfZdDafc0qPzPaJg_000JvzqfPCfFCKhLPqY/edit?ts=60f0422c#">last time this happened</a>
we weren&rsquo;t quick enough investigating it and the logs fell out of logit, preventing us
from diagnosing the true cause. So don&rsquo;t make the same mistake.</p>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
