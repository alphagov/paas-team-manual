<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Shipping Elasticsearch metrics to our tenants - PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/support/shipping_elasticsearch_metrics_to_tenants/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Shipping Elasticsearch metrics to our tenants - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/support/shipping_elasticsearch_metrics_to_tenants/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="Shipping Elasticsearch metrics to our tenants" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/support/shipping_elasticsearch_metrics_to_tenants/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#shipping-elasticsearch-metrics-to-our-tenants"><span>Shipping Elasticsearch metrics to our tenants</span></a>
    <ul>
      <li>
        <a href="#how-it-works"><span>How it works</span></a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#elasticsearch-metric-exporter-alpha"><span>Elasticsearch Metric Exporter alpha</span></a>
    <ul>
      <li>
        <a href="#elasticsearch-metric-exporter-alpha-how-it-works"><span>How it works</span></a>
      </li>
      <li>
        <a href="#limitations-of-the-alpha"><span>Limitations of the alpha</span></a>
      </li>
      <li>
        <a href="#if-something-goes-wrong"><span>If something goes wrong</span></a>
      </li>
      <li>
        <a href="#how-to-set-it-up-for-a-new-tenant"><span>How to set it up for a new tenant</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="shipping-elasticsearch-metrics-to-our-tenants">Shipping Elasticsearch metrics to our tenants</h1>
<p><strong>As of April 2022, Elasticsearch has been migrated to Opensearch. This guide may still work but there&rsquo;s no guarantee</strong></p>
<p>As of July 2020 we provide Elasticsearch metrics to several tenant
Prometheuses. This is an informal &ldquo;alpha&rdquo; and only on an in-hours,
best-effort basis.</p>
<h2 id="how-it-works">How it works</h2>
<p><a href="../../diagrams/elasticsearch-metric-exporter-alpha.jpg" rel="noopener noreferrer"><img src="../../diagrams/elasticsearch-metric-exporter-alpha.jpg" alt="Diagram of the alpha Elasticsearch Prometheus exporter" /></a>
<a href="../../diagrams/elasticsearch-metric-exporter-alpha.svg">Link to SVG version of the diagram</a></p>
<h1 id="elasticsearch-metric-exporter-alpha">Elasticsearch Metric Exporter alpha</h1>
<p><a href="https://www.elastic.co/elasticsearch/">Elasticsearch</a> is an open source full-text RESTful search and analytics engine that allows you to store and search data.</p>
<p>GOV.UK Platform as a Service (PaaS) offer Elasticsearch as a service to our tenants. We procure Elasticsearch from <a href="https://aiven.io/">Aiven</a>, who offer fully managed open source data infrastructure running in public cloud environments. The GOV.UK PaaS Elasticsearch services are hosted on AWS EC2 instances in Ireland or London, depending on your choice of GOV.UK PaaS region.</p>
<p>In addition to the core data infrastructure services, Aiven offer a HTTP REST API (<a href="https://api.aiven.io/doc/">Aiven API</a>) which allows automated access to and control of account and service configuration. Aiven also provide access to Elasticsearch metrics through <a href="https://prometheus.io/docs/concepts/jobs_instances/">Prometheus endpoints</a>.</p>
<p>However, GOV.UK PaaS tenants are not able to access the Aiven API directly for security reasons. This is because:</p>

<ul>
<li>the Aiven API access credentials allow access to all services procured by GOV.UK PaaS</li>
<li>access to Aiven services is restricted to GOV.UK PaaS IP ranges</li>
</ul>
<p>To make Elasticsearch metrics provided by the Aiven Prometheus endpoints available to our tenants, GOV.UK PaaS are developing the Elasticsearch Metric Exporter app, which is currently in alpha.</p>
<p>The code and manifests are in a <a href="https://github.com/alphagov/paas-observability-release/pull/5"><code>pull request</code></a> on <a href="https://github.com/alphagov/paas-observability-release"><code>paas-observability-release</code></a>.</p>
<h2 id="elasticsearch-metric-exporter-alpha-how-it-works">How it works</h2>
<p>The Elasticsearch Metric Exporter app runs two components, a <a href="https://prometheus.io/">Prometheus server</a> and the <code>aiven-service-discovery</code> process as a <a href="https://docs.cloudfoundry.org/devguide/sidecars.html">sidecar</a>.</p>
<p>The <code>aiven-service-discovery</code> process is configured by providing a JSON file that lists the services to collect metrics for. It then:</p>

<ul>
<li>connects to the Aiven API to identify the IP addresses of the services&rsquo; Elasticsearch nodes</li>
<li>configures the scrape targets of the Elasticsearch Metric Exporter Prometheus server.</li>
</ul>
<p>Once configured, the Elasticsearch Metric Exporter Prometheus server reads metrics from the Aiven Prometheus endpoints and stores them in an InfluxDB instance. Access to the server is provided by a <a href="https://docs.cloud.service.gov.uk/deploying_services/route_services/#example-route-service-to-add-username-and-password-authentication">basic auth route service</a>.</p>
<p>We are operating one Elasticsearch Metric Exporter instance and one basic auth route service per tenant participating in the alpha. The apps and services are deployed in the <code>monitoring</code> space of the <code>admin</code> organisation in Ireland and London, respectively.</p>
<p>Tenants are able to access their Elasticsearch metrics by providing basic authentication credentials when accessing their Elasticsearch Metric Exporter instance. They can <a href="https://prometheus.io/docs/prometheus/latest/federation/">federate</a> the metrics to a Prometheus server operated outside of GOV.UK PaaS by scraping the <code>/federate</code> endpoint of the Elasticsearch Metric Exporter instance.</p>
<h2 id="limitations-of-the-alpha">Limitations of the alpha</h2>
<p>The service list configuration of the <code>aiven-service-discovery</code> process is static. This means that if a tenant creates a new Elasticsearch service, they will not receive its metrics until the configuration is manually updated and the Elasticsearch Metric Exporter redeployed.</p>
<h2 id="if-something-goes-wrong">If something goes wrong</h2>
<p>Don&rsquo;t worry. This is an informal &ldquo;alpha&rdquo; and only on an in-hours,
best-effort basis.</p>
<p>Ideas for debugging:</p>

<ul>
<li>Access the Prometheus using the credentials from <code>cf env</code> on the
route service app

<ul>
<li>See if it is still receiving metrics</li>
<li>Look at the Targets page and see whether it is still scraping
data from all the tenant&rsquo;s Elasticsearch nodes</li>
</ul></li>
<li>Look at the Elasticsearch services in Aiven and see if you can
make metrics requests manually (use <code>cf ssh</code> so your requests come
from the PaaS IP ranges)</li>
<li>Talk to Aiven support</li>
<li>Ask Miki or Andy for help (we worked on it originally)</li>
</ul>
<h2 id="how-to-set-it-up-for-a-new-tenant">How to set it up for a new tenant</h2>
<p>Checkout the code from <a href="https://github.com/alphagov/paas-observability-release/pull/5">github.com/alphagov/paas-observability-release/pull/5</a> and make a copy of one of
the existing manifests.</p>
<p>Next you need to make a JSON file listing all their service instances
and some metadata that will be turned into Prometheus metric labels.
Unfortunately we don&rsquo;t have a script for this yet. Here&rsquo;s an example:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>[
  {
    "aiven_service": "${DEPLOY_ENV}-${SERVICE_INSTANCE_GUID}",
    "extra_labels": {
      "service_guid": "${SERVICE_INSTANCE_GUID}",
      "service_name": "${SERVICE_INSTANCE_NAME}",
      "space_guid": "${SPACE_GUID}",
      "space_name": "${SPACE_NAME}",
      "org_guid": "${ORG_GUID}",
      "org_name": "${ORG_NAME}"
    }
  },
  …
]
</code></pre></div><p>Save that list in the same directory as the manifest and alter
<code>SERVICES_FILE</code> in the manifest to be named appropriately.
Also alter the rest of the manifest so that its names match your
tenant.</p>
<p>Now it&rsquo;s time to deploy. <code>cf push</code> the manifest using <code>--var</code> to
provide values for the Aiven secrets it requires. You can get those
values from an existing app or our credential stores.</p>
<p>Visit the app URL and you should see a Prometheus interface. Check its
Targets page and you should see it scraping data from all the nodes of
the Elasticsearch services you configured in the JSON file. Check the
metric graphs look sensible (you can compare them to ones in Aiven&rsquo;s
interface.)</p>
<p>Once that&rsquo;s working OK it&rsquo;s time to deploy a basic auth service in
front of the app. Our public documentation says how to do that.</p>
<p>Finally you need to help the tenant configure their Prometheus. By
default there are 700-ish different metrics reported, and tenants
probably don&rsquo;t want to saturate their Prometheus with that much data.
We have an <a href="https://gist.github.com/46bit/bbc7f267f6115fc008c9ddb43cd56745">example Prometheus config</a>
and a <a href="https://docs.google.com/spreadsheets/d/1LffFBhe5T937MF0vYQWSH4j10niZS7IImlUAW4cYiNE/edit#gid=0">spreadsheet showing what metrics are available</a>.</p>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
