<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>How to upgrade the cf-deployment - PaaS Team Manual</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/guides/upgrade_cf-deployment/">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="How to upgrade the cf-deployment - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/guides/upgrade_cf-deployment/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="How to upgrade the cf-deployment" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/guides/upgrade_cf-deployment/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#upgrading-cf-deployment"><span>Upgrading cf-deployment</span></a>
    <ul>
      <li>
        <a href="#before-upgrading"><span>Before upgrading</span></a>
      </li>
      <li>
        <a href="#preparing-the-upgrade"><span>Preparing the upgrade</span></a>
      </li>
      <li>
        <a href="#testing-the-upgrade"><span>Testing the upgrade</span></a>
      </li>
      <li>
        <a href="#merging-the-upgrade"><span>Merging the upgrade</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="upgrading-cf-deployment">Upgrading cf-deployment</h1>
<h2 id="before-upgrading">Before upgrading</h2>

<ol>
<li>Before upgrading cf-deployment, you should check your environment is not resource starved because this can cause unexpected test failures. Typically, resource starvation in dev happens when some organisations are left over from smoke and acceptance tests. These organisation names are prefixed with SMOKE- and CATS- respectively. If tests are not running at the time, you can safely delete the organisations with the script <code>paas-cf/scripts/cleanup_leftover_test_orgs.sh</code>.</li>
<li>Avoid upgrading of cf-deployment at the same time as upgrading stemcells and/or the Bosh director. Upgrades can cause problems and our experience is that it is difficult to be certain about the cause of those problems if multiple things have changed.</li>
<li>Find out the correct version to upgrade to by checking the <a href="https://github.com/cloudfoundry/cf-deployment/releases">cf-deployment releases documentation</a>. Choose a recent stable release, but try to avoid releases less than a couple of weeks old. Discuss the planned upgrade version in kick-off.</li>
<li>Read the documentation for every version of every release in the <a href="https://github.com/cloudfoundry/cf-deployment/releases">changelog</a> since the last update. It will save you time and pain in the long run.</li>
</ol>
<h2 id="preparing-the-upgrade">Preparing the upgrade</h2>

<ol>
<li>If you have issues in the releases of cf-deployment, consider overriding the release version with an <a href="https://bosh.io/docs/cli-ops-files/">ops file</a>. For example, when <a href="https://github.com/alphagov/paas-cf/pull/2902">updating cf-deployment to version 20.2.0</a> we needed an ops file to disable a feature (dynamic ASGs) that was enabled by default by the upstream.</li>
<li>Update the submodule cf-deployment in <a href="https://github.com/alphagov/paas-cf/tree/main/manifests">manifests for paas-cf</a> to the version you chose.</li>
<li>To see and review changes to the manifest, use the <code>git diff</code> command or the GitHub Compare UI in the cf-deployment submodule repo. For example, to see differences between v21.0.0 and v21.05.0, run <code>git diff v21.0.0...v21.05.0 cf-deployment.yml</code>.</li>
<li>We also use a number of upstream ops files, so you will want to diff them too. You can find them included in the config as symlinks in <code>manifests/cf-manifest/operationds.d</code> with the suffix <code>-UPSTREAM</code>.
Special differences to take into account are:

<ul>
<li>new secrets and certificates in variables - maybe there are new passwords that must be rotated or blacklisted from rotation</li>
<li>release version changes</li>
<li>new <code>instance_groups</code> added</li>
</ul></li>
<li>Run the unit tests for the manifest with the new version of cf-deployment with <code>make test</code> or <code>cd manifests/cf-manifest &amp;&amp; bundle exec rspec --fail-fast</code>. Fix issues as you find them. If you&rsquo;re having trouble getting make test to run locally, you can see it run in GitHub Actions when you raise a PR.</li>
<li>Update the <code>cf-smoke-tests-release</code> resource in the pipeline to pin the version used in cf-deployment.</li>
<li>Update the cf-acceptance-tests resource in the pipeline to use an upstream <code>cfX.Y</code> branch matching the cf-deployment version. If we are using a forked version of the smoke-tests or cf-acceptance test, create a new branch and rebase our forked version.</li>
</ol>
<h2 id="testing-the-upgrade">Testing the upgrade</h2>
<p>You should test the upgrade changeset by doing the following:</p>

<ol>
<li>Claim one of the team development environments (dev01, dev02 or dev03) by sending a message to the <a href="https://gds.slack.com/archives/CAEHMHGJ2">#paas-internal channel</a> on GDS Slack, tagging @paas-devs.</li>
<li>Make sure the current branch of paas-cf deployed to the environment is <code>main</code>.</li>
<li><p>Update and run the pipeline with <code>SLIM_DEV_DEPLOYMENT=false</code>, which is equivalent to the change that will happen in production. For example for <code>dev01</code> issue:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>gds aws paas-dev-admin -- make dev01 pipelines BRANCH=main SLIM_DEV_DEPLOYMENT=false
</code></pre></div></li>
<li><p>Run the pipeline with the updated cf-deployment branch and make sure all acceptance tests have passed. This is important because the development environment might previously have been used to test things such as partial updates.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>gds aws paas-dev-admin -- make dev01 pipelines BRANCH=UPGRADE_BRANCH_NAME SLIM_DEV_DEPLOYMENT=false
</code></pre></div><p>where <code>UPGRADE_BRANCH_NAME</code> is the name of the branch you created for the upgrade.</p></li>
<li><p>Confirm that the process for <a href="https://team-manual.cloud.service.gov.uk/team/rotating_credentials/">rotating credentials</a> still works.</p></li>
</ol>
<h2 id="merging-the-upgrade">Merging the upgrade</h2>
<p>If all the above tests pass, merge-sign the PR. The gds-cli has a useful utility for this:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>gds git merge-sign alphagov/paas-cf &lt;PR_NUMBER&gt;
</code></pre></div><p>This will trigger our continuous deployment pipelines and move the change through staging into the production environments.</p>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
