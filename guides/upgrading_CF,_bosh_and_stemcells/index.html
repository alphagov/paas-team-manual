<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>PaaS Team Manual</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/guides/upgrading_CF,_bosh_and_stemcells/">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/guides/upgrading_CF,_bosh_and_stemcells/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/guides/upgrading_CF,_bosh_and_stemcells/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              
              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#upgrading-cf-bosh-and-stemcells"><span>Upgrading CF, BOSH and stemcells</span></a>
    <ul>
      <li>
        <a href="#before-upgrading"><span> Before Upgrading</span></a>
        <ul>
          <li>
            <a href="#credhub"><span>Credhub</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#doing-the-upgrade"><span>Doing the upgrade</span></a>
        <ul>
          <li>
            <a href="#buildpacks"><span>Buildpacks</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#notify-the-tenants"><span>Notify the tenants</span></a>
      </li>
      <li>
        <a href="#problems-encountered-previously"><span>Problems encountered previously</span></a>
        <ul>
          <li>
            <a href="#dns-name-resolution"><span>DNS name resolution.</span></a>
          </li>
          <li>
            <a href="#cf-cli"><span>CF CLI</span></a>
          </li>
          <li>
            <a href="#acceptance-test-failures"><span>Acceptance Test Failures</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="upgrading-cf-bosh-and-stemcells">Upgrading CF, BOSH and stemcells</h1><h2 id="before-upgrading"> Before Upgrading</h2>
<ul>
<li>Check your environment isn&rsquo;t resource starved, because this can cause unexpected test failures. Typically, resource starvation in dev happens when there are a number of organisations left over from smoke and acceptance tests. These are prefixed with <code>SMOKE-</code> and <code>CATS-</code> respectively. Provided tests aren&rsquo;t running at the time, they can be safely deleted with <code>cf delete-org</code>.</li>
<li>Separate the upgrade of Cloud Foundry and stemcells from the upgrade of Bosh. Upgrades can cause problems and our experience is that it is difficult to be certain about the cause of those problems if multiple things have changed.</li>
<li><p>Establish the correct version to upgrade to:</p>

<ul>
<li>Check <a href="https://github.com/cloudfoundry/cf-deployment/releases">cf-deployment releases documentation</a>.</li>
<li>Prefer the latest stable release if the release notes look like they won&rsquo;t introduce bugs.</li>
<li>Discuss the planned upgrade version in kick-off.</li>
</ul></li>
<li><p>If you encounter issues in the releases of <code>cf-deployment</code> consider forking and patching them or overriding the release version with a opsfile.</p></li>
<li><p>Update the submodule in <code>/manifests/cf-deployment</code> for <a href="https://github.com/alphagov/paas-cf/tree/master/manifests/cf-deployment">paas-cf</a> of cf-deployment to the picked version.</p></li>
<li><p>Use <code>git diff</code> or GitHub compare in the <code>cf-deployment</code> submodule repo to see and review changes to the manifest. For example, to see differences between v1.0.0 and v1.14.0:</p></li>
</ul>
<div class="highlight"><pre class="highlight plaintext"><code>  git diff v1.0.0...v1.14.0 cf-deployment.yml
</code></pre></div><p>We also use a number of upstream ops files, so you will want to <code>diff</code> them too. See <a href="https://github.com/alphagov/paas-cf/blob/master/manifests/cf-manifest/scripts/generate-manifest.sh">the manifest generation script</a> for which ones get used.</p>
<p>Special differences to take into account:</p>

<ul>
<li>New secrets and certificates in <code>variables:</code>. Maybe there are new passwords that must be rotated or blacklisted from rotation.</li>
<li>Release version changes.</li>
<li><p>New <code>instance_groups</code> added</p>

<ul>
<li>Read the documentation for every version of every release changed. It will save you time and pain in the long run.</li>
<li>Run the unit tests for the manifest with the new version of cf-deployment with <code>make test</code> or <code>(cd manifests/cf-manifest &amp;&amp; bundle exec rspec --fail-fast)</code>. Fix issues as you find them.</li>
<li>Update the cf-smoke-tests-release resource in the pipeline to pin the version used in cf-deployment.</li>
<li>Update the cf-acceptance-tests resource in the pipeline to use an upstream <code>cfX.Y</code> branch matching the cf-deployment version.</li>
<li>Note: If we are using a forked version of the smoke-tests or cf-acceptance test, create a new branch and rebase our forked version accordingly.</li>
</ul></li>
</ul>
<h3 id="credhub">Credhub</h3><p><em>(section added October 2018)</em></p>
<p>Our upgrade to cf-deployment v4.5.0 caused us to diverge from upstream, as
documented in this <a href="https://www.pivotaltracker.com/story/show/160506139/comments/195512325">story
comment</a>,
by not including their suggested <code>credhub</code> instance group.</p>
<p>This divergence isn&rsquo;t set in stone, but until a <em>CF</em>-level credhub is
introduced, you should take care to check that no BOSH releases are relying on
a <em>CF</em>-level credhub instance or service. It&rsquo;s possible that a stronger
dependency on credhub will be introduced in the future, in which case we&rsquo;ll
need to do the work to re-align with upstream before upgrading. It&rsquo;s worth
checking for this early in the upgrade story, so that any requisite work can be
flagged as a blocker ASAP.</p>
<p>NBNB Here, we&rsquo;re talking about a <em>CF</em>-level credhub - <strong>not</strong> a <em>BOSH</em>-level
credhub. We anticipate that we&rsquo;ll have one at the BOSH layer, to replace
vars-store files, Sometime Soon
(<a href="https://www.pivotaltracker.com/story/show/158978139">spike</a>). Be clear about
the different consumers of any credhubs in our environments, and which one is
being excluded at the time of writing.</p>
<h2 id="doing-the-upgrade">Doing the upgrade</h2><p>You should test the upgrade changeset:</p>

<ul>
<li>From a fully deployed master with <code>SLIM_DEV_DEPLOYMENT=false</code> set, which is equivalent to the change that will happen
in production.</li>
<li>Deploying a fresh CF, which is something we frequently do in our
development environments after the autodelete-cloudfoundry pipeline
runs overnight.</li>
<li>Confirm that <a href="/team/rotating_credentials/">rotating credentials</a> still
works and doesn&rsquo;t cause additional downtime during deployments.</li>
</ul>
<h3 id="buildpacks">Buildpacks</h3><p>Buildpack upgrades are typically done as a separate story. You should upgrade the buildpacks to at least the versions included in the cf-deployment version currently deployed.</p>
<p>We have to a give at least a week&rsquo;s notice to tenants about the buildpack upgrades, so prepare the version changes separately from the CF component upgrades.</p>
<p>There is a (semi-)automated process for upgrading buildpacks, which includes generating the email:</p>
<p>The developer does the following:</p>

<ul>
<li>In paas-cf run <code>scripts/update_buildpacks.sh</code> to update our cache of buildpack dependencies</li>
<li>Commit the changes to a branch</li>
<li>Raise a PR for the changes and move the story into review</li>
</ul>
<p>The reviewer does the following:</p>

<ul>
<li>Run <code>scripts/create_buildpacks_email.sh</code> to create the email</li>
<li>Send the email using the [google group interface] with the subject &ldquo;GOV.UK PaaS - Upcoming buildpack upgrades - $DATE&rdquo;, where $DATE is in the format &ldquo;11th September 2019&rdquo;</li>
<li>Mark the story as blocked with a blocker in the form <code>until 2019/09/11</code></li>
<li>Wait until the given date, then merge the PR to upgrade the buildpacks</li>
</ul>
<h2 id="notify-the-tenants">Notify the tenants</h2><p>Send an email to users following <a href="/team/notifying_tenants/#cf-upgrade">the upgrade template</a>.</p>
<h2 id="problems-encountered-previously">Problems encountered previously</h2><h3 id="dns-name-resolution">DNS name resolution.</h3><p>We encountered a wide variety of acceptance and smoke test failures which were intermittent. This was due to DNS health check failures. Consul uses these health checks to validate the consistency of the DNS records it serves, and will expire DNS records where the health check has failed.</p>
<p>The root cause was failure to remove the <code>consul.agent.services</code> property for Diego components in the CloudFoundry manifest. <a href="https://github.com/cloudfoundry-incubator/diego-release/releases/tag/v0.1452.0">Diego release notes for version 1452</a> did state these had to be removed, as Diego components now use the Locket library to configure its DNS health checks.</p>
<p>The solution is to read the documentation on every release you are passing, for every component you are upgrading. This is a lot of documentation, but worth it in the long run.</p>
<h3 id="cf-cli">CF CLI</h3><p>The upgrade to cf-release v233 led to acceptance test failure, as it requires CF CLI version 6.16+. We upgraded to this version in our cf-cli and cf-acceptance-tests Docker containers, which confounded the tests of other developers when merged. Upgrades to CF CLI versions can be tested using your own private containers while in development. Perhaps we should think about versioning our docker images so that we can pin particular versions in the pipeline to match the CF &amp; BOSH versions being deployed.</p>
<h3 id="acceptance-test-failures">Acceptance Test Failures</h3><p>The upgrade to v233 has introduced some new tests in the acceptance-test suite, which do not appear to be quite ready for the prime-time yet.</p>
<p>We experienced failures in:</p>

<ul>
<li><p><code>routing</code> suite - The <code>multiple_app_ports</code> test fails if  <code>users_can_select_backend</code> is not set to <code>true</code> - The test receives a response of <code>CF-BackendSelectionNotAuthorized</code> which does not match the expected response of <code>CF-MultipleAppPortsMappedDiegoToDea</code> and causes the test to fail - This test should not be run unless the user is permitted to switch backends. We raised an issue with Pivotal for this test :</p>

<ul>
<li><a href="https://www.pivotaltracker.com/story/show/117685687">Pivotal Tracker issue #117685687</a></li>
<li><a href="https://github.com/cloudfoundry/cf-acceptance-tests/issues/104">GitHub cloudfoundry/cf-acceptance-tests#104</a></li>
</ul></li>
<li><p><code>v3</code> suite - The <code>task_test</code> is being run even though we have the <code>cf-feature-flag</code> for <code>task_creation</code> set to <code>false</code> - The suite attempts to create a task and receives a response saying <code>Feature Disabled: task_creation</code> which does not cause any kind of failure - it then goes on to attempt to delete the task which fails as it receives and empty response to it&rsquo;s delete attempt, when it is expecting to receive a response indicating that the task is in a <code>FAILED</code> state</p></li>
</ul>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="../../accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>
