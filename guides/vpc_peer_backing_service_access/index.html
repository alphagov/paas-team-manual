<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>VPC Peer Backing Service Accesss - PaaS Team Manual</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://team-manual.cloud.service.gov.uk/guides/vpc_peer_backing_service_access/">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="team-manual.cloud.service.gov.uk" />
      <meta name="twitter:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="VPC Peer Backing Service Accesss - PaaS Team Manual" />
      <meta name="twitter:url" content="https://team-manual.cloud.service.gov.uk/guides/vpc_peer_backing_service_access/" />

      <meta property="og:image" content="https://team-manual.cloud.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="PaaS Team Manual" />
      <meta property="og:title" content="VPC Peer Backing Service Accesss" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://team-manual.cloud.service.gov.uk/guides/vpc_peer_backing_service_access/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://team-manual.cloud.service.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          PaaS Team Manual
        </span>
      </a>
        <strong class="govuk-tag">Internal</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://team-manual.cloud.service.gov.uk"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                      <ul>
  <li>
    <a href="#enable-access-to-backing-services-via-vpc-peering"><span>Enable access to backing services via VPC peering</span></a>
    <ul>
      <li>
        <a href="#who-can-use-this"><span>Who can use this</span></a>
      </li>
      <li>
        <a href="#pre-requisites"><span>Pre-requisites</span></a>
      </li>
      <li>
        <a href="#configuring-and-deploying-private-backing-service-access"><span>Configuring and deploying private backing service access</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <div class="page-banner">
    <p>This is for internal use by the PaaS team. Public-facing documentation is located at <a href="https://docs.cloud.service.gov.uk">docs.cloud.service.gov.uk</a>.</p>
  </div>

  <h1 id="enable-access-to-backing-services-via-vpc-peering">Enable access to backing services via VPC peering</h1>
<p>To assist tenants in migrating large databases away from GOV.UK PaaS, we allow private access to backing services over a VPC peering.</p>
<p>This is similar to <a href="/guides/vpc_peering/">how we can allow tenant applications to reach services inside a VPC peer</a>. If that is your use case
you should reach that guide instead. If your use case is two way communication, follow both guides.</p>
<h2 id="who-can-use-this">Who can use this</h2>
<p>Opening up VPC peering arrangements with access to backing services has some risk for the platform, so we do not offer it to everyone. We will have a
short chat with the tenant about their needs to work out if we can or should help them, and we think that the rough eligibility criteria are one or more of</p>

<ul>
<li>a database in excess of 100gb</li>
<li>a service with small downtime tolerances</li>
<li>to migrating, or though, AWS</li>
</ul>
<p>We cannot support private access directly to Azure, GCP, or a tenant&rsquo;s private data centre because of the burden it places on the team.</p>
<h2 id="pre-requisites">Pre-requisites</h2>
<p>Before you can set up private access to backing services, the tenant needs to have provided</p>

<ul>
<li>one or more VPC IDs to which we will peer, and the name of the environment it corresponds to on their side (e.g. dev, staging)</li>
<li>thr AWS account ID for each VPC ID</li>
<li>the CloudFoundry service GUIDs for each database they want private access to, and which of their VPCs should be able to access it</li>
</ul>
<p>You should tell the tenant</p>

<ul>
<li>we will provide them a <code>/22</code> CIDR block in the <code>172.16.0.0/16</code> range on which to peer</li>
<li>the CIDR ranges for all of our backing service subnets</li>
</ul>
<p>Tenants are responsible for configuring their networks in such a way as to allow traffic to flow between their VPC and ours. We cannot provide
them with any formal support in doing so.</p>
<p>This information must be given in a support ticket. If the tenant is emailing the support address directly, the email must come from an
address associated with their CloudFoundry org. If they raise the ticket via our support form, they must be logged in first so that we can
see who raised it.</p>
<h2 id="configuring-and-deploying-private-backing-service-access">Configuring and deploying private backing service access</h2>

<ol>
<li>Choose a subnet CIDR on which to peer. Look in <code>paas-cf/terraform/prod{-lon}.vpc_peering.json</code> for a list of current peerings, then choose the next highest subnet. The size should be <code>/22</code>. For example, if the highest subnet is <code>172.16.4.0/22</code>, choose <code>172.16.8.0/22</code>.</li>
<li>Create a new entry in <code>paas-cf/terraform/prod{-lon}.vpc_peering.json</code>. Set <code>backing_service_routing</code> to <code>true</code>. Deploy this to production.</li>
<li><p>Once it is in production, run</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>PEER_NAME=VPC_PEER_NAME DB_INSTANCE_ID=RDS_INSTANCE_IDENTIFIER \
gds aws AWS_ACCOUNT_ROLE -- make ENV enable_vpc_peer_db_access
</code></pre></div></li>
</ol>
<p>to add an extra security group to the database which allows ingress from the CIDR block, where</p>

<ul>
<li><code>VPC_PEER_NAME</code> is the name of a VPC peering configuration in the environment&rsquo;s VPC peering config file (e.g. <a href="https://github.com/alphagov/paas-cf/blob/main/terraform/prod-lon.vpc_peering.json"><code>prod-lon.vpc_peering.json</code></a>)</li>
<li><code>RDS_INSTANCE_IDENTIFIER</code> is the instance identifier of the database you are modifying. You can find this by entering the service instance guid into the AWS RDS console</li>
<li><code>AWS_ACCOUNT_ROLE</code> is the name of the AWS account and the role you are assuming via the GDS CLI</li>
<li><code>ENV</code> is the name of the GOV.UK PaaS environment (e.g. <code>dev01</code>, <code>prod</code>)</li>
</ul>
<p>If the tenant also requires their GOV.UK PaaS apps to be able to communicate with services in their VPC, follow <a href="/guides/vpc_peering/">the guide on regular VPC peering</a>.</p>
<p>It is possible to perform a dry run of the script by setting the <code>DRY</code> environment variable to <code>true</code>. In a dry run, the script will print what it is going to do, but carry out no other actions.</p>


            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility/">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
